# Chefless

A tool to make minimailzed Docker images using eght_app. This repo depends on [Docker](https://www.docker.com/community-edition) and the [Chef Development Kit](https://downloads.chef.io/chefdk).

## How does it work?

To get started, clone this repo:

```bash
> git clone git@git.8x8.com:ckeleher/Chefless.git
```

Then, run `config.sh` with the following arguments:

```bash
Usage: ./config.sh -g GIT_URL -s SERVICE -r ROLE [-b BRANCH] [-i IMAGE] [-e ENVIRONMENT] [-p PATH] [-h]
-g | --git:          The URL of a git repository which holds eght_app configuration data. Required.
-s | --service:      The service that the image will create and run. Required.
-r | --role:         A Chef role included in the given git repository. Required.
-b | --branch:       A branch of the given git repository. Optional. Defaults to 'develop'.
-i | --image:        The desired name of the Docker image to be created. Optional. Defaults to SERVICE-ENVIRONMENT-BRANCH.
-e | --environment:  A Chef environment included in the given git repository. Optional. Defaults to 'development'.
-p | --path:         The path relative to the environments folder containing the given environment file. Optional. Defaults to 'development'.
-h | --help:         Prints a help message and exits. Optional.
```

Note that `config.sh` will skip pulling the given repository if a directory already exists with the same name.Next, run `go.sh`. This will configure a Docker image with either an image name passed into `config.sh`, or with the default image name it generates if no name was given. If you wish to change the name of the image after the run finishes, you can [tag it](https://docs.docker.com/engine/reference/commandline/tag/) with the name you want to use. 

Once an image has been generated, you can optionally run `cleanup.sh`. This will remove all files generated by `config.sh`, **including the git repository it pulled**.

An example of a Chefless run targeting smp_directory is included below. Note that branch, image, and path were not given in this example because their default values were sufficient for our case.



```bash
> ./config.sh --git git@git.8x8.com:auto/chef/apps/smp.git --service smp_directory --role eght_smp_directory -e smp_development
> ./go.sh
> ./cleanup.sh
> docker images
REPOSITORY                              TAG          IMAGE ID            CREATED              SIZE
smp_directory-smp_development-develop   latest       f21b5b8d7e7a        About a minute ago   1.31GB
```

You can create a container from your image using [docker run](https://docs.docker.com/engine/reference/run/). [Kitematic](https://kitematic.com/), which comes standard with Docker Toolbox, is another useful tool for inspecting and managing containers.

## Why should I use this?

This setup provides the full ability to configure a container using eght\_app without having to install Chef or any of the systems that Chef needs. This lets you create a more lightweight container with minimal bloat.

## Dependencies

*  [Docker](https://www.docker.com/community-edition)
*  [Chef Development Kit](https://downloads.chef.io/chefdk)

## What do I do if something breaks?

Reach out to us on our mailing list, cloud-rad@8x8.com.

If you're running into a bug, please file an issue on our tracker.

## Current issues and limitations

* Containers are still somewhat large due to extra packages and features installed by the dev_tools option. Optimizing for minimal container size is an ongoing process.

## License

[Apache 2.0](LICENSE.md)